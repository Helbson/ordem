<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Contas - Firebase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot,
            serverTimestamp,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configura√ß√£o do Firebase com suas chaves
        const firebaseConfig = {
            apiKey: "AIzaSyDm2V4szjQPegs4rJlH_eCIlG8lZiOyCEE",
            authDomain: "ordem-cbc8e.firebaseapp.com",
            projectId: "ordem-cbc8e",
            storageBucket: "ordem-cbc8e.firebasestorage.app",
            messagingSenderId: "1095787217194",
            appId: "1:1095787217194:web:4f71cd1922b81af3b3de53"
        };

        // Inicializar Firebase
        let app;
        let db;
        let firebaseConnected = false;
        const COLLECTION_CONTAS = "contas";
        const COLLECTION_HISTORICO = "historicoPagamentos";
        const COLLECTION_CONFIG = "configuracoes";

        // Inicializar conex√£o
        async function initFirebase() {
            try {
                console.log("üîÑ Inicializando Firebase...");
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Testar conex√£o
                await getDocs(collection(db, COLLECTION_CONTAS));
                firebaseConnected = true;
                console.log("‚úÖ Firebase conectado com sucesso!");
                
                // Configurar listeners em tempo real
                setupRealtimeListeners();
                return true;
            } catch (error) {
                console.error("‚ùå Erro ao conectar Firebase:", error);
                alert("‚ö†Ô∏è Usando armazenamento local (Firebase offline)");
                return false;
            }
        }

        // Configurar listeners em tempo real
        function setupRealtimeListeners() {
            // Listener para contas
            const contasQuery = query(collection(db, COLLECTION_CONTAS), orderBy("createdAt", "desc"));
            onSnapshot(contasQuery, (snapshot) => {
                console.log("üîÑ Contas atualizadas em tempo real:", snapshot.size);
                loadContasFromFirebase();
            });

            // Listener para hist√≥rico
            const historicoQuery = query(collection(db, COLLECTION_HISTORICO), orderBy("dataPagamento", "desc"));
            onSnapshot(historicoQuery, (snapshot) => {
                console.log("üîÑ Hist√≥rico atualizado em tempo real:", snapshot.size);
                loadHistoricoFromFirebase();
            });
        }

        // Carregar contas do Firebase
        async function loadContasFromFirebase() {
            try {
                if (!firebaseConnected) return;
                
                const querySnapshot = await getDocs(collection(db, COLLECTION_CONTAS));
                const contasFirebase = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    contasFirebase.push({
                        id: doc.id,
                        firebaseId: doc.id,
                        praQuem: data.praQuem || "",
                        valor: data.valor || 0,
                        vencimento: data.vencimento || "",
                        pago: data.pago || false,
                        valorPago: data.valorPago || 0,
                        dataPagamento: data.dataPagamento || "",
                        observacoes: data.observacoes || "",
                        createdAt: data.createdAt || new Date().toISOString()
                    });
                });
                
                // Atualizar contas locais
                window.contas = contasFirebase;
                localStorage.setItem('contas', JSON.stringify(contasFirebase));
                window.renderizarContas();
                
            } catch (error) {
                console.error("Erro ao carregar contas:", error);
            }
        }

        // Carregar hist√≥rico do Firebase
        async function loadHistoricoFromFirebase() {
            try {
                if (!firebaseConnected) return;
                
                const querySnapshot = await getDocs(collection(db, COLLECTION_HISTORICO));
                const historicoFirebase = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    historicoFirebase.push({
                        firebaseId: doc.id,
                        id: data.id || Date.now(),
                        praQuem: data.praQuem || "",
                        valorOriginal: data.valorOriginal || 0,
                        valorPago: data.valorPago || 0,
                        dataPagamento: data.dataPagamento || "",
                        observacoes: data.observacoes || "",
                        jurosPagos: data.jurosPagos || 0,
                        createdAt: data.createdAt || new Date().toISOString()
                    });
                });
                
                // Atualizar hist√≥rico local
                window.historico = historicoFirebase;
                localStorage.setItem('historicoPagamentos', JSON.stringify(historicoFirebase));
                window.renderizarHistorico();
                
            } catch (error) {
                console.error("Erro ao carregar hist√≥rico:", error);
            }
        }

        // Salvar conta no Firebase
        async function saveContaToFirebase(conta) {
            try {
                if (!firebaseConnected) return null;
                
                const docRef = await addDoc(collection(db, COLLECTION_CONTAS), {
                    ...conta,
                    createdAt: serverTimestamp()
                });
                
                console.log("‚úÖ Conta salva no Firebase ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Erro ao salvar conta:", error);
                return null;
            }
        }

        // Atualizar conta no Firebase
        async function updateContaInFirebase(firebaseId, updates) {
            try {
                if (!firebaseConnected) return false;
                
                await updateDoc(doc(db, COLLECTION_CONTAS, firebaseId), updates);
                console.log("‚úÖ Conta atualizada no Firebase");
                return true;
            } catch (error) {
                console.error("Erro ao atualizar conta:", error);
                return false;
            }
        }

        // Excluir conta do Firebase
        async function deleteContaFromFirebase(firebaseId) {
            try {
                if (!firebaseConnected) return false;
                
                await deleteDoc(doc(db, COLLECTION_CONTAS, firebaseId));
                console.log("‚úÖ Conta exclu√≠da do Firebase");
                return true;
            } catch (error) {
                console.error("Erro ao excluir conta:", error);
                return false;
            }
        }

        // Salvar pagamento no hist√≥rico do Firebase
        async function savePagamentoToFirebase(pagamento) {
            try {
                if (!firebaseConnected) return null;
                
                const docRef = await addDoc(collection(db, COLLECTION_HISTORICO), {
                    ...pagamento,
                    createdAt: serverTimestamp()
                });
                
                console.log("‚úÖ Pagamento salvo no Firebase ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Erro ao salvar pagamento:", error);
                return null;
            }
        }

        // Inicializar ao carregar a p√°gina
        window.firebaseFunctions = {
            initFirebase,
            saveContaToFirebase,
            updateContaInFirebase,
            deleteContaFromFirebase,
            savePagamentoToFirebase,
            loadContasFromFirebase,
            loadHistoricoFromFirebase
        };
    </script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .firebase-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219653);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status.pago {
            background-color: #d4edda;
            color: #155724;
        }

        .status.atrasada {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.pendente {
            background-color: #fff3cd;
            color: #856404;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-pagar { 
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
        }
        
        .btn-editar { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-deletar { 
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-action:hover {
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .receipt {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #27ae60;
        }

        .receipt-title {
            font-size: 26px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #ddd;
        }

        .receipt-row.total {
            border-top: 3px solid #27ae60;
            padding-top: 20px;
            font-weight: bold;
            font-size: 20px;
            margin-top: 20px;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 25px;
            font-size: 13px;
            color: #95a5a6;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .receipt-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn-print {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .sync-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn-action {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1><i class="fas fa-file-invoice-dollar"></i> Gerenciador de Contas</h1>
        <p class="subtitle">Controle de contas com Firebase Sync</p>
        
        <!-- Status Firebase -->
        <div id="firebaseStatus" class="firebase-status status-disconnected">
            <i class="fas fa-spinner fa-spin"></i> Conectando ao Firebase...
        </div>

        <!-- Abas -->
        <div class="tabs">
            <button class="tab-btn active" onclick="abrirTab('contas')">
                <i class="fas fa-receipt"></i> Contas
            </button>
            <button class="tab-btn" onclick="abrirTab('historico')">
                <i class="fas fa-history"></i> Hist√≥rico
            </button>
            <button class="tab-btn" onclick="abrirTab('config')">
                <i class="fas fa-cog"></i> Configura√ß√µes
            </button>
        </div>

        <!-- Aba Contas -->
        <div id="tab-contas" class="tab-content active">
            <div class="controls">
                <button class="btn btn-success" onclick="abrirModalNovaConta()">
                    <i class="fas fa-plus-circle"></i> Nova Conta
                </button>
                <div class="sync-buttons">
                    <button class="btn" onclick="syncComFirebase()">
                        <i class="fas fa-sync-alt"></i> Sincronizar
                    </button>
                </div>
            </div>

            <table id="tabelaContas">
                <thead>
                    <tr>
                        <th>Pra quem</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaContas"></tbody>
            </table>

            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-receipt"></i>
                <h3>Nenhuma conta cadastrada</h3>
                <p>Clique em "Nova Conta" para come√ßar</p>
            </div>
        </div>

        <!-- Aba Hist√≥rico -->
        <div id="tab-historico" class="tab-content">
            <div class="controls">
                <h2><i class="fas fa-history"></i> Hist√≥rico de Pagamentos</h2>
                <button class="btn" onclick="exportarHistorico()">
                    <i class="fas fa-download"></i> Exportar CSV
                </button>
            </div>
            <div id="listaHistorico"></div>
            <div id="emptyHistorico" class="empty-state" style="display: none;">
                <i class="fas fa-history"></i>
                <h3>Nenhum pagamento registrado</h3>
            </div>
        </div>

        <!-- Aba Configura√ß√µes -->
        <div id="tab-config" class="tab-content">
            <h2><i class="fas fa-cog"></i> Configura√ß√µes</h2>
            
            <div class="config-section" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>Configura√ß√µes de Juros</h3>
                <div class="form-group">
                    <label class="form-label">Juros por dia (%):</label>
                    <input type="number" id="jurosDiario" class="form-input" value="0.33" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Multa por atraso (%):</label>
                    <input type="number" id="multaAtraso" class="form-input" value="2" step="0.1" min="0">
                </div>
                <button class="btn btn-warning" onclick="aplicarConfigJuros()">
                    <i class="fas fa-sync"></i> Aplicar Configura√ß√µes
                </button>
            </div>
            
            <div class="config-section" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3>Gerenciamento de Dados</h3>
                <button class="btn btn-success" onclick="backupDados()" style="margin-bottom: 10px;">
                    <i class="fas fa-save"></i> Backup Local
                </button>
                <button class="btn" onclick="syncComFirebase()" style="margin-bottom: 10px;">
                    <i class="fas fa-sync-alt"></i> Sincronizar com Firebase
                </button>
                <button class="btn btn-danger" onclick="limparTodosDados()">
                    <i class="fas fa-trash"></i> Limpar Todos os Dados
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nova Conta -->
    <div class="modal-overlay" id="modalNovaConta">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Nova Conta</h3>
                <button class="close-modal" onclick="fecharModal('modalNovaConta')">&times;</button>
            </div>
            <form id="formNovaConta" onsubmit="salvarNovaConta(event)">
                <div class="form-group">
                    <label class="form-label">Pra quem:</label>
                    <input type="text" id="praQuem" class="form-input" required placeholder="Nome do benefici√°rio">
                </div>
                <div class="form-group">
                    <label class="form-label">Valor (R$):</label>
                    <input type="number" id="valor" class="form-input" step="0.01" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Data de Vencimento:</label>
                    <input type="date" id="vencimento" class="form-input" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="fecharModal('modalNovaConta')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Conta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div class="modal-overlay" id="modalPagamento">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> Registrar Pagamento</h3>
                <button class="close-modal" onclick="fecharModal('modalPagamento')">&times;</button>
            </div>
            <form id="formPagamento" onsubmit="registrarPagamento(event)">
                <input type="hidden" id="pagamentoContaId">
                <input type="hidden" id="pagamentoFirebaseId">
                <div class="form-group">
                    <label class="form-label">Valor Pago (R$):</label>
                    <input type="number" id="valorPago" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Data do Pagamento:</label>
                    <input type="date" id="dataPagamento" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Observa√ß√µes (opcional):</label>
                    <textarea id="observacoes" class="form-input" rows="3" placeholder="Ex: Pago com cart√£o, transfer√™ncia, etc."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="fecharModal('modalPagamento')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Comprovante -->
    <div class="modal-overlay" id="modalComprovante">
        <div class="modal">
            <div class="receipt">
                <div class="receipt-header">
                    <h2 class="receipt-title">COMPROVANTE DE PAGAMENTO</h2>
                    <p class="receipt-subtitle" id="comprovanteId">ID: #000001</p>
                </div>
                <div class="receipt-body" id="comprovanteBody"></div>
                <div class="receipt-footer">
                    <p>Este √© um comprovante digital</p>
                    <p id="comprovanteData">Data e hora da emiss√£o: --</p>
                </div>
                <div class="receipt-actions">
                    <button class="btn-print" onclick="imprimirComprovante()">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button class="btn btn-success" onclick="fecharModal('modalComprovante')">
                        <i class="fas fa-check"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let contas = JSON.parse(localStorage.getItem('contas')) || [];
        let historico = JSON.parse(localStorage.getItem('historicoPagamentos')) || [];
        let configJuros = JSON.parse(localStorage.getItem('configJuros')) || {
            jurosDiario: 0.33,
            multaAtraso: 2
        };

        // Atualizar status do Firebase
        function updateFirebaseStatus(message, type) {
            const statusElement = document.getElementById('firebaseStatus');
            statusElement.textContent = message;
            statusElement.className = `firebase-status status-${type}`;
        }

        // Sincronizar com Firebase
        async function syncComFirebase() {
            try {
                updateFirebaseStatus("üîÑ Sincronizando com Firebase...", "disconnected");
                
                // Carregar dados do Firebase
                if (window.firebaseFunctions) {
                    await window.firebaseFunctions.loadContasFromFirebase();
                    await window.firebaseFunctions.loadHistoricoFromFirebase();
                    updateFirebaseStatus("‚úÖ Sincronizado com Firebase", "connected");
                    alert('‚úÖ Dados sincronizados com sucesso!');
                } else {
                    updateFirebaseStatus("‚ùå Firebase n√£o inicializado", "disconnected");
                }
            } catch (error) {
                console.error("Erro na sincroniza√ß√£o:", error);
                updateFirebaseStatus("‚ùå Erro na sincroniza√ß√£o", "disconnected");
            }
        }

        function abrirTab(tab) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            const tabIndex = tab === 'contas' ? 1 : tab === 'historico' ? 2 : 3;
            document.querySelector(`.tab-btn:nth-child(${tabIndex})`).classList.add('active');
            
            if (tab === 'historico') renderizarHistorico();
        }

        function formatarValor(valor) {
            return 'R$ ' + parseFloat(valor).toFixed(2).replace('.', ',');
        }

        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            return new Date(dataString).toLocaleDateString('pt-BR');
        }

        function calcularJuros(conta) {
            if (conta.pago) {
                return { 
                    juros: conta.valorPago - conta.valor, 
                    multa: 0, 
                    total: conta.valorPago 
                };
            }

            const hoje = new Date();
            const vencimento = new Date(conta.vencimento);
            const dias = Math.ceil((hoje - vencimento) / (1000 * 60 * 60 * 24));
            
            if (dias <= 0) return { juros: 0, multa: 0, total: conta.valor };

            const multa = conta.valor * (configJuros.multaAtraso / 100);
            const juros = conta.valor * (configJuros.jurosDiario / 100) * dias;
            const total = conta.valor + multa + juros;
            return { juros, multa, total };
        }

        function renderizarContas() {
            const lista = document.getElementById('listaContas');
            const emptyState = document.getElementById('emptyState');
            
            if (contas.length === 0) {
                lista.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            lista.innerHTML = '';
            
            contas.forEach(conta => {
                const { total, juros, multa } = calcularJuros(conta);
                const hoje = new Date();
                const vencimento = new Date(conta.vencimento);
                const atrasada = !conta.pago && vencimento < hoje;
                const venceHoje = !conta.pago && vencimento.toDateString() === hoje.toDateString();
                
                let statusText = 'Pendente';
                let statusClass = 'pendente';
                
                if (conta.pago) {
                    statusText = 'Pago';
                    statusClass = 'pago';
                } else if (atrasada) {
                    statusText = 'Atrasada';
                    statusClass = 'atrasada';
                } else if (venceHoje) {
                    statusText = 'Vence hoje';
                    statusClass = 'pendente';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${conta.praQuem}</strong></td>
                    <td>${formatarValor(conta.valor)}</td>
                    <td>${formatarData(conta.vencimento)}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${!conta.pago ? `
                                <button class="btn-action btn-pagar" onclick="abrirModalPagamento('${conta.id}', '${conta.firebaseId || ''}')">
                                    <i class="fas fa-money-bill-wave"></i> Pagar
                                </button>
                            ` : ''}
                            <button class="btn-action btn-deletar" onclick="deletarConta('${conta.id}', '${conta.firebaseId || ''}')">
                                <i class="fas fa-trash"></i> Apagar
                            </button>
                        </div>
                    </td>
                `;
                lista.appendChild(tr);
            });
        }

        function abrirModalNovaConta() {
            document.getElementById('modalNovaConta').style.display = 'flex';
            document.getElementById('vencimento').value = new Date().toISOString().split('T')[0];
            document.getElementById('praQuem').focus();
        }

        function fecharModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function salvarNovaConta(event) {
            event.preventDefault();
            
            const praQuem = document.getElementById('praQuem').value.trim();
            const valor = parseFloat(document.getElementById('valor').value);
            const vencimento = document.getElementById('vencimento').value;

            const novaConta = {
                id: Date.now().toString(),
                praQuem,
                valor,
                vencimento,
                pago: false,
                createdAt: new Date().toISOString()
            };

            // Salvar localmente
            contas.push(novaConta);
            localStorage.setItem('contas', JSON.stringify(contas));
            
            // Salvar no Firebase se dispon√≠vel
            if (window.firebaseFunctions) {
                const firebaseId = await window.firebaseFunctions.saveContaToFirebase(novaConta);
                if (firebaseId) {
                    novaConta.firebaseId = firebaseId;
                    // Atualizar no array local
                    const index = contas.findIndex(c => c.id === novaConta.id);
                    if (index !== -1) {
                        contas[index].firebaseId = firebaseId;
                        localStorage.setItem('contas', JSON.stringify(contas));
                    }
                }
            }

            renderizarContas();
            fecharModal('modalNovaConta');
            document.getElementById('formNovaConta').reset();
            
            alert('‚úÖ Conta salva com sucesso!');
        }

        function abrirModalPagamento(id, firebaseId) {
            const conta = contas.find(c => c.id === id);
            if (!conta) return;

            document.getElementById('pagamentoContaId').value = id;
            document.getElementById('pagamentoFirebaseId').value = firebaseId || '';
            document.getElementById('valorPago').value = calcularJuros(conta).total.toFixed(2);
            document.getElementById('dataPagamento').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalPagamento').style.display = 'flex';
            document.getElementById('valorPago').focus();
        }

        async function registrarPagamento(event) {
            event.preventDefault();
            
            const id = document.getElementById('pagamentoContaId').value;
            const firebaseId = document.getElementById('pagamentoFirebaseId').value;
            const valorPago = parseFloat(document.getElementById('valorPago').value);
            const dataPagamento = document.getElementById('dataPagamento').value;
            const observacoes = document.getElementById('observacoes').value.trim();

            const conta = contas.find(c => c.id === id);
            if (!conta) return;

            // Atualizar conta localmente
            const contaIndex = contas.findIndex(c => c.id === id);
            contas[contaIndex].pago = true;
            contas[contaIndex].valorPago = valorPago;
            contas[contaIndex].dataPagamento = dataPagamento;
            contas[contaIndex].observacoes = observacoes;
            
            // Criar registro de pagamento
            const jurosPagos = valorPago - conta.valor;
            const pagamento = {
                id: Date.now().toString(),
                praQuem: conta.praQuem,
                valorOriginal: conta.valor,
                valorPago,
                dataPagamento,
                observacoes,
                jurosPagos,
                createdAt: new Date().toISOString()
            };

            historico.push(pagamento);
            
            // Salvar localmente
            localStorage.setItem('contas', JSON.stringify(contas));
            localStorage.setItem('historicoPagamentos', JSON.stringify(historico));
            
            // Salvar no Firebase se dispon√≠vel
            if (window.firebaseFunctions) {
                // Atualizar conta no Firebase
                if (firebaseId) {
                    await window.firebaseFunctions.updateContaInFirebase(firebaseId, {
                        pago: true,
                        valorPago,
                        dataPagamento,
                        observacoes
                    });
                }
                
                // Salvar pagamento no hist√≥rico do Firebase
                await window.firebaseFunctions.savePagamentoToFirebase(pagamento);
            }

            renderizarContas();
            fecharModal('modalPagamento');
            mostrarComprovante(pagamento);
            
            alert('‚úÖ Pagamento registrado com sucesso!');
        }

        function mostrarComprovante(pagamento) {
            const jurosPagos = pagamento.valorPago - pagamento.valorOriginal;
            document.getElementById('comprovanteId').textContent = `ID: #${pagamento.id}`;
            document.getElementById('comprovanteBody').innerHTML = `
                <div class="receipt-row">
                    <span class="receipt-label">Benefici√°rio:</span>
                    <span class="receipt-value">${pagamento.praQuem}</span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Data do Pagamento:</span>
                    <span class="receipt-value">${formatarData(pagamento.dataPagamento)}</span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Valor Original:</span>
                    <span class="receipt-value">${formatarValor(pagamento.valorOriginal)}</span>
                </div>
                ${jurosPagos > 0 ? `
                <div class="receipt-row">
                    <span class="receipt-label">Juros/Multa:</span>
                    <span class="receipt-value">${formatarValor(jurosPagos)}</span>
                </div>` : ''}
                <div class="receipt-row total">
                    <span class="receipt-label">VALOR PAGO:</span>
                    <span class="receipt-value">${formatarValor(pagamento.valorPago)}</span>
                </div>
                ${pagamento.observacoes ? `
                <div class="receipt-row">
                    <span class="receipt-label">Observa√ß√µes:</span>
                    <span class="receipt-value">${pagamento.observacoes}</span>
                </div>` : ''}
            `;
            document.getElementById('comprovanteData').textContent = `Emitido em: ${new Date().toLocaleString('pt-BR')}`;
            document.getElementById('modalComprovante').style.display = 'flex';
        }

        function imprimirComprovante() {
            const conteudo = document.querySelector('.receipt').innerHTML;
            const janela = window.open('', '_blank', 'width=600,height=800');
            janela.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Comprovante de Pagamento</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .receipt { border: 2px solid #000; padding: 30px; max-width: 500px; margin: 0 auto; }
                        .receipt-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px; }
                        .receipt-title { font-size: 24px; margin: 0; }
                        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #000; }
                        .receipt-row.total { border-top: 3px solid #000; padding-top: 15px; font-weight: bold; font-size: 18px; }
                        @media print { body { margin: 0; padding: 0; } }
                    </style>
                </head>
                <body>
                    <div class="receipt">${conteudo}</div>
                    <script>
                        window.onload = function() { window.print(); setTimeout(function() { window.close(); }, 1000); }
                    <\/script>
                </body>
                </html>
            `);
            janela.document.close();
        }

        async function deletarConta(id, firebaseId) {
            if (!confirm('Deseja realmente excluir esta conta?')) return;

            // Remover localmente
            contas = contas.filter(c => c.id !== id);
            localStorage.setItem('contas', JSON.stringify(contas));
            
            // Remover do Firebase se dispon√≠vel
            if (window.firebaseFunctions && firebaseId) {
                await window.firebaseFunctions.deleteContaFromFirebase(firebaseId);
            }

            renderizarContas();
            alert('‚úÖ Conta exclu√≠da com sucesso!');
        }

        function aplicarConfigJuros() {
            configJuros.jurosDiario = parseFloat(document.getElementById('jurosDiario').value);
            configJuros.multaAtraso = parseFloat(document.getElementById('multaAtraso').value);
            localStorage.setItem('configJuros', JSON.stringify(configJuros));
            alert('‚úÖ Configura√ß√µes de juros aplicadas!');
            renderizarContas();
        }

        function exportarHistorico() {
            if (historico.length === 0) {
                alert('N√£o h√° hist√≥rico para exportar.');
                return;
            }
            
            let csv = 'Data,Benefici√°rio,Valor Original,Valor Pago,Juros Pagos,Observa√ß√µes\n';
            historico.forEach(h => {
                const juros = h.valorPago - h.valorOriginal;
                csv += `"${formatarData(h.dataPagamento)}","${h.praQuem}",${h.valorOriginal},${h.valorPago},${juros},"${h.observacoes}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historico_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function backupDados() {
            const backup = {
                contas,
                historico,
                configJuros,
                data: new Date().toISOString(),
                totalContas: contas.length,
                totalHistorico: historico.length,
                valorTotal: contas.reduce((sum, c) => sum + (c.pago ? 0 : c.valor), 0)
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_contas_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            alert('‚úÖ Backup criado com sucesso!');
        }

        async function limparTodosDados() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODAS as contas e hist√≥rico. Deseja continuar?')) return;

            contas = [];
            historico = [];
            localStorage.setItem('contas', JSON.stringify(contas));
            localStorage.setItem('historicoPagamentos', JSON.stringify(historico));
            
            renderizarContas();
            renderizarHistorico();
            
            alert('‚úÖ Todos os dados foram limpos!');
        }

        function renderizarHistorico() {
            const lista = document.getElementById('listaHistorico');
            const empty = document.getElementById('emptyHistorico');
            
            if (historico.length === 0) {
                lista.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            lista.innerHTML = '';
            
            historico.forEach(h => {
                const div = document.createElement('div');
                div.style.cssText = `
                    padding: 20px;
                    border: 1px solid #e0e0e0;
                    margin-bottom: 15px;
                    border-radius: 10px;
                    cursor: pointer;
                    transition: all 0.3s;
                    background: white;
                `;
                div.onmouseover = () => div.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
                div.onmouseout = () => div.style.boxShadow = 'none';
                div.onclick = () => mostrarComprovante(h);
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong style="font-size: 1.1rem; color: #2c3e50;">${h.praQuem}</strong><br>
                            <div style="margin-top: 8px; color: #666;">
                                <div>üìÖ Data: ${formatarData(h.dataPagamento)}</div>
                                <div>üí∞ Valor Original: ${formatarValor(h.valorOriginal)}</div>
                                <div>üíµ Valor Pago: <strong style="color: #27ae60;">${formatarValor(h.valorPago)}</strong></div>
                                ${h.jurosPagos > 0 ? `<div>üìà Juros/Multa: ${formatarValor(h.jurosPagos)}</div>` : ''}
                                ${h.observacoes ? `<div>üìù Obs: ${h.observacoes}</div>` : ''}
                            </div>
                        </div>
                        <i class="fas fa-eye" style="color: #3498db; font-size: 1.2rem;"></i>
                    </div>
                `;
                lista.appendChild(div);
            });
        }

        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) this.style.display = 'none';
            });
        });

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar Firebase
            if (window.firebaseFunctions) {
                const connected = await window.firebaseFunctions.initFirebase();
                if (connected) {
                    updateFirebaseStatus("‚úÖ Conectado ao Firebase", "connected");
                    await window.firebaseFunctions.loadContasFromFirebase();
                    await window.firebaseFunctions.loadHistoricoFromFirebase();
                } else {
                    updateFirebaseStatus("‚ö†Ô∏è Usando armazenamento local", "disconnected");
                }
            } else {
                updateFirebaseStatus("‚ùå Firebase n√£o dispon√≠vel", "disconnected");
            }
            
            // Carregar configura√ß√µes
            document.getElementById('jurosDiario').value = configJuros.jurosDiario;
            document.getElementById('multaAtraso').value = configJuros.multaAtraso;
            
            // Renderizar dados
            renderizarContas();
            renderizarHistorico();
            
            console.log('‚úÖ Gerenciador de Contas inicializado!');
        });
    </script>

</body>
</html>