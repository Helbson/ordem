<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ordem de Serviço</title>
  <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://www.googleapis.com;">
  <style>
    body {font-family: Arial, sans-serif; margin:0; background:#f0f2f5; display:flex; justify-content:center; align-items:center; min-height:100vh;}
    #login {background:#1a1a2e; color:white; padding:50px; border-radius:20px; text-align:center; width:90%; max-width:400px;}
    #painel {display:none; background:white; color:#000; width:90%; max-width:600px; border-radius:15px; padding:20px; min-height:90vh;}
    input, textarea, button {width:100%; padding:15px; margin:12px 0; border-radius:10px; border:none; font-size:17px;}
    input, textarea {background:#0f0f1a; color:white;}
    button {background:#00ff88; color:black; font-weight:bold;}
    .card {background:#ecf0f1; padding:15px; margin:15px 0; border-radius:10px;}
    .em-progresso {background:#f39c12; color:white; padding:5px 10px; border-radius:5px;}
    .finalizado {background:#27ae60; color:white; padding:5px 10px; border-radius:5px;}
    .sair {background:#c0392b !important; color:white !important;}
  </style>
</head>
<body>

<div id="login">
  <h1>ORDEM DE SERVIÇO</h1>
  <input type="password" id="senha" placeholder="Digite a senha">
  <button onclick="entrar()">ENTRAR</button>
  <p id="erro" style="color:#ff6b6b;display:none;">Senha errada!</p>
</div>

<div id="painel">
  <h1 style="text-align:center; color:#2c3e50;">Ordem de Serviço</h1>
  <button onclick="sair()" class="sair">SAIR</button>
  <textarea id="descricao" placeholder="Ex: Visitar Regina, entregar 20g..." rows="3"></textarea>
  <button onclick="criarOrdem()">Criar Ordem</button>
  <div id="lista">Carregando...</div>
  <div style="border-top:3px dashed #333; margin:40px 0 20px; padding-top:20px;">
    <h2 style="text-align:center; color:#27ae60;">Histórico Finalizado</h2>
    <div id="historico"></div>
  </div>
</div>

<script type="module">
  const SENHA = "2025"; // ← troca aqui se quiser

  const login = document.getElementById("login");
  const painel = document.getElementById("painel");

  window.entrar = () => {
    if (document.getElementById("senha").value === SENHA) {
      login.style.display = "none";
      painel.style.display = "block";
      sessionStorage.setItem("ok","sim");
      atualizarTudo();
    } else {
      document.getElementById("erro").style.display = "block";
    }
  };

  window.sair = () => {
    if (confirm("Sair?")) {
      sessionStorage.removeItem("ok");
      login.style.display = "block";
      painel.style.display = "none";
      document.getElementById("senha").value = "";
    }
  };

  if (sessionStorage.getItem("ok") === "sim") {
    login.style.display = "none";
    painel.style.display = "block";
    setTimeout(atualizarTudo, 500);
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDm2V4szjQPegs4rJlH_eCIlG8lZiOyCEE",
    authDomain: "ordem-cbc8e.firebaseapp.com",
    projectId: "ordem-cbc8e",
    storageBucket: "ordem-cbc8e.firebasestorage.app",
    messagingSenderId: "1095787217194",
    appId: "1:1095787217194:web:4f71cd1922b81af3b3de53"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.criarOrdem = async () => {
    const t = document.getElementById("descricao").value.trim();
    if (!t) return alert("Digite algo");
    await addDoc(collection(db, "ordens"), {descricao: t, status: "em-progresso", valor: 0, criadoEm: serverTimestamp()});
    document.getElementById("descricao").value = "";
  };

  function atualizarTudo() {
    const l = document.getElementById("lista");
    const h = document.getElementById("historico");
    onSnapshot(query(collection(db, "ordens"), orderBy("criadoEm", "desc")), s => {
      l.innerHTML = ""; h.innerHTML = "";
      let aberto = false;
      s.forEach(d => {
        const data = d.data();
        const tempo = data.criadoEm?.toDate?.().toLocaleString('pt-BR') || "Agora";
        const card = document.createElement("div");
        card.className = "card";
        if (data.status === "em-progresso") {
          aberto = true;
          card.innerHTML = `<strong>${data.descricao}</strong><br><small>${tempo}</small><br><br>
            <span class="em-progresso">EM PROGRESSO</span>
            <div id="c-${d.id}" style="display:none;margin-top:10px;">
              <input type="number" id="v-${d.id}" placeholder="Valor">
              <button onclick="finalizar('${d.id}')">Finalizar</button>
            </div>
            <button onclick="document.getElementById('c-${d.id}').style.display='block'" style="background:#3498db;color:white;margin-top:10px;width:100%;">
              Recebi → Digitar valor
            </button>`;
          l.appendChild(card);
        } else {
          card.innerHTML = `<strong>${data.descricao}</strong><br><small>${tempo}</small><br>
            <span class="finalizado">FINALIZADO</span><br>
            <strong style="color:#27ae60;font-size:18px;">R$ ${data.valor}</strong>`;
          h.appendChild(card);
        }
      });
      if (!aberto) l.innerHTML = "<p style='text-align:center;color:#777;'>Nenhuma ordem em aberto</p>";
    });
  }

  window.finalizar = async (id) => {
    const v = document.getElementById("v-" + id).value;
    if (!v || v <= 0) return alert("Digite o valor");
    await updateDoc(doc(db, "ordens", id), {status: "finalizado", valor: Number(v)});
  };
</script>
</body>
</html>
